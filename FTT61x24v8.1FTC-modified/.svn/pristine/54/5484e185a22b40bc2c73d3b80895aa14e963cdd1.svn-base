% Author: Adrian Odenweller (ao459@cam.ac.uk), January 2019
% Edited by JFM May 2019 to add to FTC version 8

function [ULB,GLB,Curt,Ustor,CostStor,Hp] = FTT61x24v8RLDC(G,CF,S,k)
% Returns load band heights, curtailment, storage and peak load data from
% Residual Load Duration Curves (RLDCs).
% Input:
%  Sw: share of generation of wind in units of total load, i.e. generation, e.g. Sw=1
%   means annual wind generation equals annual load
%  Ss: share of generation of solar in units of total load, i.e. generation
%  k: index of world region for which data is sought
% Output (in vector RLDC):
%  C1,C2,C3,C4,C5: height of load bands 1 to 4 and peak band 5 (including
%   reserve margin), normalised so that the sum of the boxes (taking
%   different load band width into account) is the share of load to be
%   covered by non-VRE
%  Curt: Curtailment (overproduction) as a share of VRE generation
%  Ustor: Storage capacity requirement as a share of peak load
%  CostStor: Short-term storage costs in $ per W of peak load



%function [H1,H2,H3,H4,Hp,Curt,Ustor,CostStor] = ...
%    FTT53x24v6RLDCraw(Sw,Ss,RLDCreg)
% Returns approximated data of Residual Load Duration Curves (RLDCs) as
% described in Ueckerdt et al. (2017), Energy Economics 64.
% All parameters are fitted as third-degree polynomials of VRE shares.
% Input:
%  Sw: share of wind in units of total load
%  Ss: share of solar in units of total load, i.e. generation
%  k: index of world region for which data is sought
% Output:
%  H1,H2,H3,H4,Hp: cumulative height of load bands 1 to 4 and peak band,
%   normalised so that the sum of the boxes (taking different load band
%   width into account) is the share of load to be covered by non-VRE
%  Curt: Curtailment (overproduction) as a share of VRE generation
%  Ustor: Storage capacity requirement as a share of peak load
%  CostStor: Short-term storage costs in $ per W of peak load

%--------------------------------------------------------------------------
%-----Additional parameters and settings for RLDC approach, CHANGES OKAY!
%--------------------------------------------------------------------------
Windi = 17:18;  % Indices of wind power technologies for RLDC
Solari = 19;  % Indices of solar power technologies for RLDC
Backup = 1.2;  % Backup factor as reserve margin (% of peak load)
NET = 24; NWR = 61;
Gamma = zeros(NET,NWR);  % Adjustment constant for other costs ($/MWh)
%Share of generation of wind before curtailment (I include Wave)
Sw = (G(17)+G(18)+G(22))/sum(G);
%Share of generation of solar
Ss = G(19)/sum(G);

% Mapping of NWR = 53 world regions to 8 available RLDC regions:
% 1 = Europe, 2 = Latin America, 3 = India, 4 = USA, 5 = Japan, 6 = Middle
% East and North Africa, 7 = Sub-Saharan Africa, 8 = China
RLDCregmap(1:33) = 1;  % Europe
RLDCregmap(34) = 4;  % USA
RLDCregmap(35) = 5;  % Japan
RLDCregmap(36:38) = 4;  % Canada, Australia, New Zealand (USA as proxy)
RLDCregmap(39:40) = 1;  % Russia, Rest of Annex I (Europe as proxy)
RLDCregmap(41) = 8;  % China
RLDCregmap(42) = 3;  % India
RLDCregmap(43:47) = 2;  % Mexico, Brazil, Argentina, Colombia, Rest of LAM
RLDCregmap(48:49) = 5;  % Korea, Taiwan (Japan as proxy)
RLDCregmap(50:51) = 3;  % Indonesia, Rest of ASEAN (India as proxy)
RLDCregmap(52) = 6;  % OPEC excluding Venezuela (MENA as proxy)
RLDCregmap(53) = 7;  % Rest of the world (Sub-Saharan Africa as proxy)
RLDCregmap(54) = 1;  % Ukraine (Europe as proxy)
RLDCregmap(55) = 6;  % Saudi (MENA as proxy)
RLDCregmap(56:58) = 7;  % Nigeria, South Africa, Rest Africa (Africa as proxy)
RLDCregmap(59) = 6;  % Africa OPEC (MENA as proxy)
RLDCregmap(60:61) = 3;  % Malaysia,Kazakhstan (India as proxy)

% Define matrices with polynomial coefficients for 8 RLDC regions
% Europe (RLDCreg = 1)
CoeffEU = [ 0.000  0.000  0.000  1.301  1.175  1.058  0.871  1.386; ...
            0.048  0.000  0.000 -1.066 -1.189 -1.013 -1.138 -0.588; ...
            0.017  0.000  0.000 -0.467 -0.806 -0.756 -1.729 -0.483; ...
           -0.220  0.039  0.038  0.602  0.783  0.124  0.064  0.013; ...
           -0.191  0.513 -0.008 -0.585  0.402 -0.588  1.359 -0.662; ...
           -0.046  1.435  1.157 -0.171  1.013  0.004  1.135 -0.397; ...
            0.336 -0.020 -0.018 -0.172 -0.302  0.024  0.151  0.079; ...
            0.556  0.000  0.163 -0.223 -0.993  0.341 -0.281  0.000; ...
            0.191 -0.197  0.731  0.346 -0.657  0.108 -0.476  0.255; ...
            0.309 -0.736 -0.593  0.158 -0.578  0.112 -0.244  0.299; ];

% Latin America (RLDCreg = 2)
CoeffLAM = [ 0.000  0.000  0.000  1.224  1.160  1.080  0.875  1.312; ...
             0.005  0.000  0.000 -0.707 -0.962 -1.014 -1.308 -0.627; ...
             0.002  0.000  0.000 -0.142 -0.219 -0.712 -1.893 -0.377; ...
            -0.064  0.106  0.026  0.094  0.530  0.260  0.367  0.286; ...
            -0.059  0.642  0.599 -1.118 -0.615 -0.822  1.703 -0.678; ...
             0.112  1.293  0.743 -0.615 -0.316  0.106  1.441 -0.593; ...
             0.247  0.003  0.059  0.018 -0.257 -0.096  0.041 -0.133; ...
             0.393 -0.379 -0.283  0.252 -0.261  0.346 -0.418  0.293; ...
             0.159  0.109  0.403  0.576  0.438  0.429 -0.638  0.265; ...
             0.062 -0.366  0.143  0.162 -0.023 -0.140 -0.367  0.278 ];

% India (RLDCreg = 3)
CoeffIndia = [ 0.000  0.000  0.000  1.111  1.060  1.020  0.960  1.182; ...
               0.002  0.059  0.016 -0.614 -0.685 -0.872 -1.749 -0.517; ...
               0.002  0.000  0.000 -0.064 -0.085 -0.382 -2.195 -0.127; ...
               0.190 -0.056 -0.011  0.616  0.665  0.705  1.020  0.484; ...
              -0.052  0.368  0.493 -0.808 -1.068 -1.165  2.389 -0.296; ...
               0.052  1.779  1.008 -0.574 -0.323 -0.117  1.791 -0.833; ...
               0.150  0.118  0.002 -0.292 -0.357 -0.373 -0.205 -0.195; ...
               0.306  0.024 -0.085  0.016 -0.045 -0.020 -0.636 -0.140; ...
               0.301 -0.311 -0.209  0.611  0.836  0.836 -1.001  0.348; ...
               0.161 -0.807 -0.051  0.102 -0.086 -0.116 -0.487  0.343; ];

% USA (RLDCreg = 4)
CoeffUSA = [ 0.000  0.000  0.000  1.381  1.176  1.029  0.872  1.544; ...
             0.018  0.001  0.000 -0.838 -0.949 -0.957 -1.280 -0.687; ...
             0.006  0.000  0.000 -1.558 -0.881 -0.555 -1.601 -1.934; ...
            -0.119  0.029  0.036  0.492  0.420  0.100  0.238  0.330; ...
            -0.112  0.490  0.235 -1.032 -0.190 -0.644  1.588 -0.822; ...
             0.052  1.314  0.819  1.853  0.924 -0.219  0.915  2.325; ...
             0.263  0.026 -0.012 -0.257 -0.206 -0.001  0.109 -0.186; ...
             0.532 -0.314 -0.181  0.477 -0.084  0.358 -0.425  0.317; ...
             0.175  0.128  0.506  0.351 -0.287  0.195 -0.527  0.454; ...
             0.153 -0.674 -0.233 -0.963 -0.574  0.138 -0.159 -1.148; ];

% Japan (RLDCreg = 5)
CoeffJapan = [ 0.000  0.000  0.000  1.275  1.147  1.045  0.891  1.429; ...
               0.001  0.000  0.000 -0.802 -0.985 -1.030 -1.462 -0.514; ...
               0.000  0.226  0.000 -0.719 -0.419 -0.565 -1.813 -1.172; ...
              -0.036  0.067  0.037  0.592  0.856  0.633  0.607  0.337; ...
              -0.007  0.800  0.853 -1.065 -0.622 -0.797  1.854 -1.125; ...
               0.280  0.971  1.225  0.369  0.143  0.040  1.309  0.901; ...
               0.330 -0.034 -0.014 -0.236 -0.397 -0.311 -0.051 -0.121; ...
               0.135  0.000  0.000  0.395 -0.163  0.031 -0.474  0.093; ...
               0.009 -0.308 -0.328  0.302  0.053  0.259 -0.670  0.471; ...
               0.041 -0.542 -0.628 -0.107 -0.093  0.033 -0.315 -0.287; ];

% Middle East and North Africa (RLDCreg = 6)
CoeffMENA = [ 0.000  0.000  0.000  1.217  1.154  1.073  0.885  1.283; ...
              0.050  0.084  0.010 -0.997 -1.058 -1.045 -1.133 -0.795; ...
              0.050  0.000  0.000 -0.136 -0.387 -1.202 -1.779 -0.312; ...
             -0.185 -0.125  0.003  0.362  0.252  0.113  0.066  0.231; ...
             -0.351  0.409  0.339 -0.530 -0.661 -0.293  1.542 -0.436; ...
             -0.206  1.571  0.930 -0.807 -0.276  1.335  1.189 -0.743; ...
              0.229  0.062  0.009 -0.109 -0.055 -0.004  0.136 -0.039; ...
              0.650 -0.133 -0.185 -0.296 -0.118  0.304 -0.294  0.000; ...
              0.621 -0.091  0.083  0.448  0.553  0.073 -0.561  0.168; ...
              0.367 -0.806 -0.227  0.374  0.058 -0.799 -0.260  0.442; ];

% Sub-Saharan Africa (RLDCreg = 7);
CoeffSSA = [ 0.000  0.000  0.000  1.165  1.093  1.043  0.929  1.225; ...
             0.050  0.023  0.000 -0.977 -0.979 -1.065 -1.206 -0.977; ...
             0.044  0.000  0.000  0.000 -0.137 -0.703 -2.062 -0.084; ...
            -0.196 -0.031  0.038  0.409  0.284  0.265  0.100  0.742; ...
            -0.344  0.547  0.384 -0.714 -0.814 -0.592  1.817 -0.426; ...
            -0.141  1.619  0.803 -0.827 -0.426  0.344  1.557 -0.985; ...
             0.258  0.014 -0.018 -0.106 -0.077 -0.096  0.143 -0.273; ...
             0.681 -0.019 -0.184 -0.058 -0.084  0.206 -0.399 -0.294; ...
             0.598 -0.392  0.239  0.586  0.713  0.555 -0.688  0.478; ...
             0.266 -0.579  0.172  0.236  0.007 -0.336 -0.392  0.410; ];

% China (RLDCreg = 8);
CoeffChina = [ 0.000  0.000  0.000  1.176  1.131  1.037  0.908  1.201; ...
               0.008  0.109  0.000 -0.778 -0.921 -0.855 -1.039 -0.447; ...
               0.004  0.000  0.000 -0.470 -0.658 -0.629 -1.881 -0.550; ...
              -0.073 -0.060  0.067  0.205  0.313 -0.045 -0.157  0.055; ...
              -0.087  0.588  0.725 -0.674 -0.052 -0.757  1.434 -0.875; ...
               0.073  1.571  1.093  0.019  0.680  0.239  1.282  0.076; ...
               0.211  0.009 -0.034 -0.034 -0.133  0.054  0.233 -0.007; ...
               0.426  0.000 -0.177 -0.107 -0.412  0.259 -0.273  0.189; ...
               0.252 -0.226 -0.066  0.471 -0.200  0.349 -0.489  0.339; ...
               0.191 -0.806 -0.434 -0.023 -0.491 -0.174 -0.291  0.005; ];

% Concatenate coefficient arrays
Coeff = cat(3, CoeffEU, CoeffLAM, CoeffIndia, CoeffUSA, CoeffJapan, ...
    CoeffMENA, CoeffSSA, CoeffChina);

% Format vector including Sw and Ss powers and cross terms
VREpowers = [1 Sw Ss Sw^2 Sw*Ss Ss^2 Sw^3 Sw^2*Ss Sw*Ss^2 Ss^3];

% Perform calculation of coefficients from polynomials. Note that in
% Ueckerdt et al. (2017) columns H1 to H4 are erroneously given in the
% opposite order (confirmed by personal correspondence).
temp = num2cell(VREpowers * Coeff(:,:,RLDCregmap(k)));
[Curt,Ustor,CostStor,H4,H3,H2,H1,Hp] = temp{:};

%Capacity factors from Ueckerdt 2017 (except for Hp which I assume 1%)
if sum(G([17 18 19 22])) > 0
    CFvar = (S(17)*CF(17)+S(18)*CF(18)+S(19)*CF(19)+S(22)*CF(22))/sum(S([17 18 19 22]))*(1-Curt);
else
    CFvar = 1;
end
CFLB = [7500 4400 2200 700 80 CFvar*8766]/8766;
%Generation in VRE
GLB(6) = sum(G([17 18 19 22]))/sum(G);

%Heights of load bands: normalised such that sum(GLB) = 1 (i.e. sum(ULB) > 1) ..
ULB(1) = 8760/7500 * max(H1,0);  % Factor due to capacity factor limit of band
ULB(2) = (max(H2,0) - max(H1,0));
ULB(3) = (max(H3,0) - max(H2,0));
ULB(4) = (max(H4,0) - max(H3,0));
ULB(5) = (Backup*max(Hp,0) - max(H4,0));
ULB(6) = GLB(6)/CFLB(6); %This is the VRE load band
%Generation in each load band: normalised such that sum(GLB) = D
GLB = ULB.*CFLB;
%Correct minor errors from polynomials
GLB = GLB/sum(GLB);
%Re-evaluate load band sizes requiring that sum(GLB) = 1
ULB = GLB./CFLB;



end
